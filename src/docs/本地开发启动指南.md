# 本地开发启动指南

面向：在本机完整拉起 Web + API + PostgreSQL + MinIO + vLLM，用于端到端联调与自测。

> 说明：本仓库支持两种本地启动方式。
>
> - **标准方式（推荐）**：API 也跑在 Docker Compose 里（`src/infra/compose/dev.yml`）。
> - **兜底方式（网络受限）**：Docker 只跑 PostgreSQL/MinIO，API 在宿主机用 `uv` 运行（避免构建时从 Docker Hub 拉取 `python:3.11-slim`）。

---

## 0. 前置条件

- Python：`>= 3.11`
- Node.js / npm：用于前端（建议使用项目已有的版本管理方式）
- Docker：用于 PostgreSQL/MinIO（以及标准方式的 API 容器）
- `uv`：Python 依赖管理（项目约定）

常用端口：

- Web：`5173`
- API：`8000`
- vLLM（OpenAI 兼容）：`8001`
- PostgreSQL：`5432`
- MinIO S3：`9000`
- MinIO Console：`9001`

---

## 1. 准备环境变量（.env）

仓库根目录提供了示例文件：`.env.example`。

- 第一次启动：复制为 `.env` 并按你的运行方式调整。

```bash
cp .env.example .env
```

关键变量：

- `DATABASE_URL`
- `MINIO_ENDPOINT` / `MINIO_ACCESS_KEY` / `MINIO_SECRET_KEY`
- `LLM_BASE_URL` / `LLM_MODEL`
- `JWT_SECRET`

> 注意：如果你变更了 `JWT_SECRET`，浏览器里旧的 `token` 会立刻失效，可能导致前端出现一次 `/api/auth/me 401`。

---

## 2. 安装后端依赖（uv）

在仓库根目录执行：

```bash
uv sync --extra dev
```

这会创建/更新项目虚拟环境 `.venv/`，也为本地启动 vLLM 脚本提供 Python 解释器。

---

## 3. 启动本地 vLLM（8001）

项目提供脚本：[src/scripts/start_vllm_dev.sh](../scripts/start_vllm_dev.sh)。

最常用启动方式：

```bash
bash src/scripts/start_vllm_dev.sh
```

如果你需要显式指定模型路径（示例）：

```bash
MODEL_PATH=/home/<you>/.cache/modelscope/hub/models/Qwen/Qwen2___5-1___5B-Instruct \
PORT=8001 \
bash src/scripts/start_vllm_dev.sh
```

启动后自检：

```bash
curl -sS http://localhost:8001/v1/models | head
```

---

## 4A. 标准方式（推荐）：Docker Compose 拉起 API + PostgreSQL + MinIO

### 4A.1 启动

```bash
docker compose -f src/infra/compose/dev.yml up -d --build
```

### 4A.2 .env 对齐要点

在标准方式下：

- API 在容器内运行，连接数据库应使用 compose 网络名：
  - `DATABASE_URL=postgresql+psycopg://postgres:postgres@postgres:5432/clinic_sim`
- API 访问宿主机 vLLM 推荐使用：
  - `LLM_BASE_URL=http://host.docker.internal:8001`

### 4A.3 查看日志

```bash
docker compose -f src/infra/compose/dev.yml logs -f api
```

---

## 4B. 兜底方式（网络受限）：Docker 只拉起 PostgreSQL/MinIO，API 在宿主机运行

适用场景：构建 API 镜像时无法从 Docker Hub 拉取基础镜像（例如 `python:3.11-slim` 超时）。

### 4B.1 启动 PostgreSQL/MinIO

```bash
docker compose -f src/infra/compose/dev.yml up -d --pull never postgres minio
```

### 4B.2 宿主机启动 API（8000）

关键点：在宿主机运行 API 时，应连接 `localhost` 端口。

示例（一次性覆盖环境变量启动）：

```bash
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/clinic_sim \
MINIO_ENDPOINT=localhost:9000 \
LLM_BASE_URL=http://localhost:8001 \
uv run uvicorn src.apps.api.main:app --host 0.0.0.0 --port 8000 --reload
```

---

## 5. 初始化数据库（Alembic 迁移）

如果你是第一次启动（或数据库卷是空的），需要执行迁移。

### 5.1 宿主机运行迁移（兜底方式常用）

```bash
uv run alembic -c src/apps/api/alembic.ini upgrade head
```

### 5.2 容器内运行迁移（标准方式常用）

```bash
docker compose -f src/infra/compose/dev.yml exec api \
  uv run alembic -c src/apps/api/alembic.ini upgrade head
```

---

## 6. （可选）导入内置病例数据

仓库内置了 `src/cases/` 下的 JSON 病例，可按需导入。

```bash
uv run python src/scripts/import_cases.py
```

---

## 7. 启动前端（5173）

```bash
cd src/apps/web
npm install
npm run dev
```

启动后打开：

- http://localhost:5173/

前端开发代理：Vite 会将 `/api` 代理到后端（默认 `http://localhost:8000`）。

---

## 8. 冒烟检查（建议每次启动后做一次）

```bash
# API 健康检查
curl -sS -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

# vLLM 可用性
curl -sS -o /dev/null -w '%{http_code}\n' http://localhost:8001/v1/models

# MinIO Console
curl -sS -o /dev/null -w '%{http_code}\n' http://localhost:9001/
```

---

## 9. 停止与清理

### 9.1 停止前端

在运行 `npm run dev` 的终端按 `Ctrl+C`。

### 9.2 停止 API（宿主机方式）

在运行 `uvicorn --reload` 的终端按 `Ctrl+C`。

### 9.3 停止 Docker 服务

```bash
docker compose -f src/infra/compose/dev.yml down
```

如需连数据卷一起清理（会清空数据库/MinIO 数据，谨慎）：

```bash
docker compose -f src/infra/compose/dev.yml down -v
```
