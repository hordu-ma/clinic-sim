# 随机病例模式开发清单

本清单用于指导在现有“病例库模式”基础上新增“随机病例模式”，并确保随机病例可评分、可复用、可审计。

---

## 目标摘要

- **新增随机病例模式**：AI 生成病例，仍保持“AI 扮演病人”一致性。
- **可评分**：随机病例生成时同步产出标准答案与评分依据。
- **可复用**：随机病例需要落库，可供回溯与复用。
- **前端入口**：在病例列表中新增“随机病例”入口并高亮展示。

---

## 一、数据库层

### 方案建议

复用现有 `cases` 表，新增字段区分病例来源。

### 需要的变更

- **新增字段**
  - `source`：`fixed | random`，区分病例来源
  - `generation_meta`（可选，JSON）：记录生成提示词、模型版本、时间等元信息
  - `marriage_childbearing_history`（可选，Text）：婚育个人史
  - `family_history`（可选，Text）：家族史
  - `case_number`（可选，int）：随机病例序号
  - `is_active`（bool, default=True）：是否启用

### 注意（本地/测试环境）

- 修改模型字段后，需要执行迁移（例如：`alembic upgrade head`），否则测试/运行时可能因缺少新列而失败。

### 相关文件

- `src/apps/api/models/cases.py`
- `src/apps/api/migrations/versions/*.py`

---

## 二、后端业务层（新增随机病例生成服务）

### 新增服务文件

- `src/apps/api/services/case_generation.py`

### 主要职责

- `generate_random_case_payload()`：调用 LLM 生成结构化病例（主诉、病史、体征、检查等）与标准答案（standard_diagnosis/key_points/recommended_tests）
- 输出结果落库到 `cases` 表，`source = random`

---

## 三、会话创建接口扩展

### 目标

在创建会话时支持 `mode`：

- `fixed`：原有流程（通过 `case_id`）
- `random`：调用随机病例生成流程

### 相关文件

- `src/apps/api/routes/sessions.py`
- `src/apps/api/schemas/sessions.py`

### 关键改动

- `SessionCreateRequest` 增加 `mode` 字段
- `random` 模式下：
  1. 调用 `case_generation.generate_case()`
  2. 生成病例并写入 `cases`
  3. 创建 session 绑定生成的 `case_id`

### 生成一致性校验（建议）

- `recommended_tests`（如存在）应当全部属于 `available_tests[].type`，否则会导致检查申请失败。

---

## 四、评分逻辑支持随机病例

### 目标

随机病例也可评分，评分逻辑从病例中读取标准答案与评分规则。

### 相关文件

- `src/apps/api/services/scoring.py`

### 关键改动

- 随机病例生成时必须写入：
  - 标准诊断答案
  - 关键问诊点/检查合理性规则
- 评分逻辑统一读取病例字段，无需区分固定/随机

---

## 五、聊天逻辑一致性保证

### 目标

随机病例必须**固定设定**，聊天过程中不允许漂移。

### 相关文件

- `src/apps/api/routes/chat.py`

### 关键改动

- 对话 prompt 只基于数据库中的病例档案构建
- 不在聊天过程中“再生成”病例设定

---

## 六、前端入口调整

### 目标

病例列表中新增“随机练习病例”入口并高亮显示。

### 相关文件

- `src/apps/web/src/views/CaseList.vue`
- `src/apps/web/src/api/session.ts`

### 关键改动

- 在列表顶部插入虚拟项：`随机练习病例`
- UI 高亮（颜色或区块强调）
- 创建会话时传 `mode=random`

---

## 七、类型与接口文档同步

### 相关文件

- `src/apps/api/schemas/sessions.py`
- `src/apps/web/src/types/api.ts`

### 关键改动

- `SessionCreateRequest` / 前端类型增加 `mode` 字段

---

## 说明与后续扩展建议

- 评分可沿用现有规则引擎，无需新增评分服务
- 随机病例建议记录生成参数，以便排查质量问题
- 后续可扩展为“练习模式/考试模式”等多模式体系

---

## 下一步执行建议

1. 先完成数据库字段与迁移
2. 补充随机病例生成服务
3. 扩展 Session 创建流程
4. 修改前端入口与调用逻辑
5. 验证评分链路在随机病例场景下可用
